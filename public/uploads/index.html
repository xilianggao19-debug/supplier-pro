<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM Pro 协同系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="loginPage" class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-indigo-600">
            <h1 class="text-2xl font-bold text-center mb-6">智慧供应链登录</h1>
            <div class="space-y-4">
                <input id="loginUser" type="text" placeholder="用户名" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <input id="loginPass" type="password" placeholder="密码" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">进入系统</button>
            </div>
        </div>
    </div>

    <div id="mainPage" class="hidden flex h-screen overflow-hidden">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0">
            <div class="p-6 text-white font-bold text-xl flex items-center gap-2"><i data-lucide="shield-check"></i> SRM Pro</div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="showSection('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition"><i data-lucide="layout-grid"></i> 控制台</button>
                <button onclick="showSection('orders')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition"><i data-lucide="shopping-cart"></i> 订单中心</button>
                <button id="navProducts" onclick="showSection('products')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition"><i data-lucide="package"></i> SKU 档案库</button>
                <button id="navUsers" onclick="showSection('users')" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition"><i data-lucide="users"></i> 供应商管理</button>
            </nav>
            <div class="p-4 border-t border-slate-800"><button onclick="logout()" class="text-red-400 text-xs flex items-center gap-2"><i data-lucide="log-out"></i> 退出系统</button></div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
            <!-- Dashboard -->
            <div id="section-dashboard" class="section space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-white">
                    <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg"><h5>总采购额</h5><h2 id="stat-amount" class="text-3xl font-bold">￥0</h2></div>
                    <div class="bg-amber-500 p-6 rounded-2xl shadow-lg"><h5>待处理订单</h5><h2 id="stat-pending" class="text-3xl font-bold">0</h2></div>
                    <div class="bg-emerald-500 p-6 rounded-2xl shadow-lg"><h5>活跃供应商</h5><h2 id="stat-total" class="text-3xl font-bold">0</h2></div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><canvas id="supplierChart" height="100"></canvas></div>
            </div>

            <!-- Orders -->
            <div id="section-orders" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">订单列表</h2>
                    <div class="flex gap-2">
                        <button onclick="exportOrdersExcel()" class="bg-emerald-50 text-emerald-600 border px-4 py-2 rounded-lg">导出报表</button>
                        <button id="btnAddOrder" onclick="openOrderModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">发布订单</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500"><tr><th class="p-4">单号</th><th class="p-4">详情</th><th class="p-4">供应商</th><th class="p-4">总价</th><th class="p-4">状态</th><th class="p-4 text-right">操作</th></tr></thead><tbody id="orderTableBody" class="divide-y"></tbody></table>
                </div>
            </div>

            <!-- Products -->
            <div id="section-products" class="section hidden space-y-6">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800">SKU 产品库</h2><button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">新增 SKU</button></div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase"><tr><th class="p-4">SKU 编号</th><th class="p-4">产品名称</th><th class="p-4">规格</th><th class="p-4">单价</th><th class="p-4 text-right">操作</th></tr></thead><tbody id="productTableBody" class="divide-y divide-slate-100"></tbody></table></div>
            </div>

            <!-- Users -->
            <div id="section-users" class="section hidden space-y-6">
                <div class="flex justify-between items-center"><h2 class="text-2xl font-bold">账号管理</h2><button onclick="addNewSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">新增账号</button></div>
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden"><table class="w-full text-left text-sm"><thead class="bg-slate-50"><tr><th class="p-4">供应商</th><th class="p-4">用户名</th><th class="p-4">状态</th><th class="p-4 text-right">操作</th></tr></thead><tbody id="userTableBody" class="divide-y"></tbody></table></div>
            </div>
        </main>
    </div>

    <script>
        let token = localStorage.getItem('srm_token');
        let currentUser = JSON.parse(localStorage.getItem('srm_user') || '{}');
        let productsCache = [];
        let chartInstance = null;

        // 核心请求拦截器
        async function api(url, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const res = await fetch(url, options);
            if (res.status === 401 || res.status === 403) { logout(); throw 'Session Expired'; }
            
            const text = await res.text();
            try {
                return JSON.parse(text);
            } catch(e) {
                console.error("服务器返回了非JSON内容:", text);
                Swal.fire('服务器响应格式错误', '后端可能崩溃了或路径不对，请检查Zeabur日志', 'error');
                throw 'JSON Parse Error';
            }
        }

        window.onload = () => { if (token) enterSystem(); lucide.createIcons(); };

        async function handleLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const res = await fetch('/api/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) });
            const data = await res.json();
            if(data.success) {
                token = data.token; currentUser = data.user;
                localStorage.setItem('srm_token', token); localStorage.setItem('srm_user', JSON.stringify(currentUser));
                enterSystem();
            } else { Swal.fire('登录失败', data.message, 'error'); }
        }

        function enterSystem() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            if(currentUser.role !== 'admin') {
                ['navProducts', 'navUsers', 'btnAddOrder'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
            }
            showSection('dashboard');
        }

        function logout() { localStorage.clear(); location.reload(); }

        async function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            if(name === 'dashboard') loadDashboard();
            if(name === 'orders') loadOrders();
            if(name === 'products') loadProducts();
            if(name === 'users') loadUsers();
            lucide.createIcons();
        }

        async function loadDashboard() {
            const data = await api('/api/stats/admin');
            document.getElementById('stat-amount').innerText = `￥${(data.stats.amount||0).toLocaleString()}`;
            document.getElementById('stat-pending').innerText = data.stats.pending;
            document.getElementById('stat-total').innerText = data.chart.length;
            const ctx = document.getElementById('supplierChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels: data.chart.map(i => i.name), datasets: [{ label: '采购金额', data: data.chart.map(i => i.value), backgroundColor: '#6366f1' }] } });
        }

        async function loadProducts() {
            productsCache = await api('/api/products');
            const body = document.getElementById('productTableBody');
            body.innerHTML = productsCache.map(p => `<tr class="hover:bg-slate-50"><td class="p-4 font-bold text-slate-400 text-xs">${p.sku}</td><td class="p-4 font-bold">${p.name}</td><td class="p-4">${p.spec}</td><td class="p-4 text-indigo-600 font-bold">￥${p.unit_price}</td><td class="p-4 text-right"><button onclick="deleteProduct(${p.id})" class="text-red-400">删除</button></td></tr>`).join('');
        }

        async function openProductModal() {
            const { value: f } = await Swal.fire({ title: '新增产品', html: `<input id="sw-sku" class="swal2-input" placeholder="SKU 编号"><input id="sw-name" class="swal2-input" placeholder="名称"><input id="sw-spec" class="swal2-input" placeholder="规格"><input id="sw-price" type="number" class="swal2-input" placeholder="单价">`, preConfirm: () => ({ sku: document.getElementById('sw-sku').value, name: document.getElementById('sw-name').value, spec: document.getElementById('sw-spec').value, unit_price: document.getElementById('sw-price').value }) });
            if(f && f.sku) { await api('/api/products', { method: 'POST', body: JSON.stringify(f) }); loadProducts(); }
        }

        async function deleteProduct(id) { if(confirm('确认删除?')) { await api(`/api/products/${id}`, { method: 'DELETE' }); loadProducts(); } }

        async function loadOrders() {
            const data = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            document.getElementById('orderTableBody').innerHTML = data.map(o => `<tr><td class="p-4 font-bold text-indigo-600">#${o.order_no}</td><td class="p-4">${o.name}<br><small class="text-slate-400">${o.spec} x ${o.quantity}</small></td><td class="p-4">${o.supplier_name}</td><td class="p-4 font-bold">￥${o.total_price}</td><td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${o.status==='已完成'?'bg-emerald-100 text-emerald-600':'bg-amber-100 text-amber-600'}">${o.status}</span></td><td class="p-4 text-right">${currentUser.role==='admin'&&o.status==='已发货'?`<button onclick="confirmReceive(${o.id})" class="bg-indigo-600 text-white px-2 py-1 rounded text-xs">确认收货</button>`:'-'}</td></tr>`).join('');
        }

        async function openOrderModal() {
            if(productsCache.length === 0) productsCache = await api('/api/products');
            const suppliers = await api('/api/suppliers-list');
            const { value: f } = await Swal.fire({
                title: '发布订单',
                html: `<select id="md-sku" class="swal2-input" onchange="autoFillProduct(this.value)"><option value="">- 选择 SKU -</option>${productsCache.map(p=>`<option value="${p.sku}">${p.sku}</option>`).join('')}</select><input id="md-name" class="swal2-input" readonly><input id="md-spec" class="swal2-input" readonly><input id="md-qty" type="number" class="swal2-input" placeholder="数量"><input id="md-price" type="number" class="swal2-input" placeholder="单价"><select id="md-supplier" class="swal2-input"><option value="">- 选择供应商 -</option>${suppliers.map(s=>`<option value="${s.id}">${s.nickname}</option>`).join('')}</select>`,
                preConfirm: () => ({ order_no: 'PO'+Date.now().toString().slice(-6), sku: document.getElementById('md-sku').value, name: document.getElementById('md-name').value, spec: document.getElementById('md-spec').value, quantity: document.getElementById('md-qty').value, unit_price: document.getElementById('md-price').value, supplier_id: document.getElementById('md-supplier').value })
            });
            if(f && f.sku) { await api('/api/orders', { method: 'POST', body: JSON.stringify(f) }); loadOrders(); }
        }

        function autoFillProduct(sku) { const p = productsCache.find(x => x.sku === sku); if(p) { document.getElementById('md-name').value = p.name; document.getElementById('md-spec').value = p.spec; document.getElementById('md-price').value = p.unit_price; } }

        async function loadUsers() {
            const data = await api('/api/admin/users');
            document.getElementById('userTableBody').innerHTML = data.map(u => `<tr><td class="p-4 font-bold">${u.nickname}</td><td class="p-4">${u.username}</td><td class="p-4">${u.status?'正常':'禁用'}</td><td class="p-4 text-right"><button onclick="toggleUser(${u.id}, ${u.status})" class="text-xs">${u.status?'禁用':'启用'}</button></td></tr>`).join('');
        }

        async function addNewSupplier() {
            const { value: v } = await Swal.fire({ title: '开通账号', html: `<input id="sw-un" class="swal2-input" placeholder="用户名"><input id="sw-pw" class="swal2-input" placeholder="密码"><input id="sw-nk" class="swal2-input" placeholder="供应商全称">`, preConfirm: () => ({ username: document.getElementById('sw-un').value, password: document.getElementById('sw-pw').value, nickname: document.getElementById('sw-nk').value }) });
            if(v) { await api('/api/admin/users', { method: 'POST', body: JSON.stringify(v) }); loadUsers(); }
        }

        async function toggleUser(id, cur) { await api('/api/admin/users/update', { method: 'POST', body: JSON.stringify({id, status: cur?0:1}) }); loadUsers(); }
        
        async function exportOrdersExcel() {
            const data = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Orders");
            XLSX.writeFile(wb, "orders.xlsx");
        }
    </script>
</body>
</html>