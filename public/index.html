<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM 供应商协同系统 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar-item-active { background: #4f46e5; color: white; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- 登录界面 -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h1 class="text-2xl font-bold text-center mb-6 text-indigo-600">SRM 智慧供应链</h1>
            <div class="space-y-4">
                <input id="loginUser" type="text" placeholder="用户名 (admin/supply)" class="w-full border p-3 rounded-xl outline-none">
                <input id="loginPass" type="password" placeholder="密码 (123)" class="w-full border p-3 rounded-xl outline-none">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">立即登录</button>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainPage" class="hidden flex h-screen">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col">
            <div class="p-6 text-white font-bold text-xl border-b border-slate-800">Supplier Pro</div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showSection('dashboard')" class="nav-btn sidebar-item-active w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="layout-grid"></i> 控制台
                </button>
                <button onclick="showSection('orders')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="shopping-cart"></i> 订单管理
                </button>
                <button id="navProducts" onclick="showSection('products')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="package"></i> SKU库管理
                </button>
            </nav>
            <div class="p-6 border-t border-slate-800">
                <div class="text-sm mb-2" id="userNameDisplay"></div>
                <button onclick="logout()" class="text-red-400 flex items-center gap-2 hover:text-red-300">
                    <i data-lucide="log-out" class="w-4 h-4"></i> 退出系统
                </button>
            </div>
        </aside>

        <!-- 内容区 -->
        <main class="flex-1 overflow-y-auto p-8">
            
            <!-- 控制台 Section -->
            <div id="section-dashboard" class="section space-y-8">
                <h2 class="text-2xl font-bold">工作台概览</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-slate-500 text-sm">总采购额</p>
                        <h3 class="text-3xl font-bold mt-1" id="stat-amount">￥0.00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-slate-500 text-sm">待处理订单</p>
                        <h3 class="text-3xl font-bold mt-1 text-amber-600" id="stat-pending">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <p class="text-slate-500 text-sm">合作供应商</p>
                        <h3 class="text-3xl font-bold mt-1" id="stat-total">0</h3>
                    </div>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <canvas id="supplierChart" height="100"></canvas>
                </div>
            </div>

            <!-- 订单管理 Section -->
            <div id="section-orders" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">订单流水</h2>
                    <button id="btnAddOrder" onclick="openOrderModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700">发布新订单</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 text-xs uppercase">
                            <tr>
                                <th class="p-4">订单编号 / SKU</th>
                                <th class="p-4">产品详情</th>
                                <th class="p-4">供应商</th>
                                <th class="p-4">金额</th>
                                <th class="p-4">状态</th>
                                <th class="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- SKU库管理 Section -->
            <div id="section-products" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">SKU 档案库</h2>
                    <button onclick="openProductModal()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-emerald-700">新增档案</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b border-slate-100 text-slate-500 text-xs uppercase">
                            <tr>
                                <th class="p-4">SKU 编号</th>
                                <th class="p-4">名称</th>
                                <th class="p-4">规格</th>
                                <th class="p-4">标准单价</th>
                                <th class="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" class="text-sm divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- 下单弹窗 -->
    <template id="orderModal">
        <div class="text-left space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400">选择产品 (自动填充规格单价)</label>
                <select id="md-sku" class="w-full border p-2 rounded-lg mt-1" onchange="autoFillProduct(this.value)">
                    <option value="">-- 请选择 SKU --</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input id="md-name" placeholder="产品名称" class="border p-2 rounded-lg" readonly>
                <input id="md-spec" placeholder="规格" class="border p-2 rounded-lg" readonly>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <input id="md-qty" type="number" placeholder="采购数量" class="border p-2 rounded-lg">
                <input id="md-price" type="number" placeholder="采购单价" class="border p-2 rounded-lg">
            </div>
            <div>
                <label class="text-xs font-bold text-slate-400">选择供应商</label>
                <select id="md-supplier" class="w-full border p-2 rounded-lg mt-1"></select>
            </div>
        </div>
    </template>

    <script>
        let currentUser = null;
        let productsCache = [];
        let chartInstance = null;

        // 页面初始化
        window.onload = () => {
            const saved = localStorage.getItem('srm_user');
            if(saved) {
                currentUser = JSON.parse(saved);
                enterSystem();
            }
            lucide.createIcons();
        };

        // 登录逻辑
        async function handleLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                if(data.success) {
                    currentUser = data.user;
                    localStorage.setItem('srm_user', JSON.stringify(currentUser));
                    enterSystem();
                }
            } catch(e) {
                Swal.fire('错误', '账号或密码不正确', 'error');
            }
        }

        function enterSystem() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = `当前用户：${currentUser.nickname}`;
            
            // 权限显隐
            if(currentUser.role !== 'admin') {
                document.getElementById('navProducts').classList.add('hidden');
                document.getElementById('btnAddOrder').classList.add('hidden');
            }
            
            showSection('dashboard');
            loadBaseData();
        }

        function logout() {
            localStorage.removeItem('srm_user');
            location.reload();
        }

        async function loadBaseData() {
            const res = await fetch('/api/products');
            productsCache = await res.json();
        }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('sidebar-item-active'));
            event?.currentTarget?.classList?.add('sidebar-item-active');

            if(name === 'dashboard') loadStats();
            if(name === 'orders') loadOrders();
            if(name === 'products') loadProducts();
            lucide.createIcons();
        }

        // --- 统计图表 ---
        async function loadStats() {
            const res = await fetch('/api/stats/admin');
            const data = await res.json();
            document.getElementById('stat-amount').innerText = `￥${(data.stats.amount || 0).toLocaleString()}`;
            document.getElementById('stat-pending').innerText = data.stats.pending || 0;
            document.getElementById('stat-total').innerText = data.chart.length;

            const ctx = document.getElementById('supplierChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.chart.map(i => i.name),
                    datasets: [{
                        label: '各供应商采购总额',
                        data: data.chart.map(i => i.value),
                        backgroundColor: '#6366f1'
                    }]
                }
            });
        }

        // --- SKU 管理 ---
        async function loadProducts() {
            const res = await fetch('/api/products');
            const data = await res.json();
            const body = document.getElementById('productTableBody');
            body.innerHTML = data.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-mono font-bold">${p.sku}</td>
                    <td class="p-4">${p.name}</td>
                    <td class="p-4">${p.spec}</td>
                    <td class="p-4">￥${p.unit_price}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-600">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        async function openProductModal() {
            const { value: formValues } = await Swal.fire({
                title: '新增 SKU 档案',
                html: `
                    <input id="sw-sku" class="swal2-input" placeholder="SKU 编号">
                    <input id="sw-name" class="swal2-input" placeholder="名称">
                    <input id="sw-spec" class="swal2-input" placeholder="规格">
                    <input id="sw-price" type="number" class="swal2-input" placeholder="单价">
                `,
                focusConfirm: false,
                preConfirm: () => ({
                    sku: document.getElementById('sw-sku').value,
                    name: document.getElementById('sw-name').value,
                    spec: document.getElementById('sw-spec').value,
                    unit_price: document.getElementById('sw-price').value
                })
            });
            if(formValues) {
                await fetch('/api/products', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formValues)
                });
                loadProducts();
            }
        }

        // --- 订单管理 ---
        async function loadOrders() {
            const res = await fetch(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const data = await res.json();
            const body = document.getElementById('orderTableBody');
            body.innerHTML = data.map(o => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4">
                        <div class="font-bold">#${o.order_no}</div>
                        <div class="text-xs text-slate-400">${o.sku}</div>
                    </td>
                    <td class="p-4">
                        <div>${o.name}</div>
                        <div class="text-xs text-slate-400">${o.spec} x ${o.quantity}</div>
                    </td>
                    <td class="p-4">${o.supplier_name}</td>
                    <td class="p-4 font-bold">￥${o.total_price.toLocaleString()}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${getStatusStyle(o.status)}">
                            ${o.status}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        ${getActionButton(o)}
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function getStatusStyle(s) {
            if(s === '待确认') return 'bg-amber-100 text-amber-700';
            if(s === '已发货') return 'bg-blue-100 text-blue-700';
            return 'bg-emerald-100 text-emerald-700';
        }

        function getActionButton(o) {
            if(currentUser.role === 'admin' && o.status === '已发货') {
                return `<button onclick="receiveOrder(${o.id})" class="bg-emerald-600 text-white px-3 py-1 rounded text-xs">确认收货</button>`;
            }
            if(currentUser.role === 'supplier' && o.status === '待确认') {
                return `<button onclick="confirmShipping(${o.id})" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs">去发货</button>`;
            }
            return '<span class="text-slate-300">-</span>';
        }

        async function openOrderModal() {
            const suppliersRes = await fetch('/api/suppliers-list');
            const suppliers = await suppliersRes.json();
            
            const { value: formValues } = await Swal.fire({
                title: '发布采购订单',
                html: document.getElementById('orderModal').innerHTML,
                didOpen: () => {
                    const skuSelect = document.getElementById('md-sku');
                    productsCache.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.sku;
                        opt.text = `${p.sku} - ${p.name}`;
                        skuSelect.appendChild(opt);
                    });
                    const supSelect = document.getElementById('md-supplier');
                    suppliers.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.text = s.nickname;
                        supSelect.appendChild(opt);
                    });
                },
                preConfirm: () => ({
                    order_no: 'PO' + Date.now().toString().slice(-6),
                    sku: document.getElementById('md-sku').value,
                    name: document.getElementById('md-name').value,
                    spec: document.getElementById('md-spec').value,
                    quantity: document.getElementById('md-qty').value,
                    unit_price: document.getElementById('md-price').value,
                    supplier_id: document.getElementById('md-supplier').value
                })
            });

            if(formValues) {
                await fetch('/api/orders', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formValues)
                });
                Swal.fire('成功', '订单已发送给供应商', 'success');
                loadOrders();
            }
        }

        function autoFillProduct(sku) {
            const p = productsCache.find(x => x.sku === sku);
            if(p) {
                document.getElementById('md-name').value = p.name;
                document.getElementById('md-spec').value = p.spec;
                document.getElementById('md-price').value = p.unit_price;
            }
        }

        async function confirmShipping(id) {
            const { value: fileData } = await Swal.fire({
                title: '发货确认',
                html: `
                    <input id="sw-express" class="swal2-input" placeholder="快递/物流公司">
                    <input id="sw-no" class="swal2-input" placeholder="物流单号">
                    <p class="text-xs text-slate-400 mt-4">请上传发货单和质检报告 (可选)</p>
                    <input type="file" id="sw-file1" class="mt-2 text-xs">
                `,
                preConfirm: () => ({
                    orderId: id,
                    logistics_company: document.getElementById('sw-express').value,
                    tracking_no: document.getElementById('sw-no').value,
                    note: document.getElementById('sw-file1').files[0]
                })
            });

            if(fileData) {
                const fd = new FormData();
                fd.append('orderId', id);
                fd.append('logistics_company', fileData.logistics_company);
                fd.append('tracking_no', fileData.tracking_no);
                if(fileData.note) fd.append('note', fileData.note);

                await fetch('/api/orders/confirm', { method: 'POST', body: fd });
                Swal.fire('发货成功', '等待管理员确认收货', 'success');
                loadOrders();
            }
        }

        async function receiveOrder(id) {
            await fetch('/api/orders/receive', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id})
            });
            Swal.fire('完成', '订单已入库', 'success');
            loadOrders();
        }
    </script>
</body>
</html>