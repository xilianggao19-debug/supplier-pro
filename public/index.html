<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM 企业级供应商系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 引入 Excel 导出库 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .sidebar-item-active { background: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- 登录 -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-indigo-600">
            <h1 class="text-2xl font-bold text-center mb-2 text-slate-800">智慧供应链系统</h1>
            <p class="text-slate-400 text-center mb-8 text-sm">Secure Authentication Pro</p>
            <div class="space-y-4">
                <input id="loginUser" type="text" placeholder="用户名" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <input id="loginPass" type="password" placeholder="密码" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">进入系统</button>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainPage" class="hidden flex h-screen">
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col">
            <div class="p-6 text-white font-bold text-xl flex items-center gap-2">
                <i data-lucide="shield-check" class="text-indigo-400"></i> SRM Pro
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="showSection('dashboard')" class="nav-btn sidebar-item-active w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> 控制台
                </button>
                <button onclick="showSection('orders')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> 订单中心
                </button>
                <button id="navProducts" onclick="showSection('products')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800">
                    <i data-lucide="package" class="w-5 h-5"></i> SKU库
                </button>
                <button id="navUsers" onclick="showSection('users')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800">
                    <i data-lucide="users" class="w-5 h-5"></i> 供应商管理
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <div class="text-xs text-slate-500 mb-3" id="userNameDisplay"></div>
                <div class="space-y-2">
                    <button onclick="changeOwnPassword()" class="w-full text-left text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-2">
                        <i data-lucide="key" class="w-3 h-3"></i> 修改我的密码
                    </button>
                    <button onclick="logout()" class="w-full text-left text-xs text-red-400 hover:text-red-300 flex items-center gap-2">
                        <i data-lucide="log-out" class="w-3 h-3"></i> 退出系统
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
            <!-- 各个 Section 容器 -->
            <div id="section-dashboard" class="section space-y-6">
                <h2 class="text-2xl font-bold text-slate-800">数据概览</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="stats-grid"></div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><canvas id="supplierChart"></canvas></div>
            </div>

            <div id="section-orders" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">采购订单</h2>
                    <div class="flex gap-3">
                        <button onclick="exportOrdersExcel()" class="bg-emerald-50 text-emerald-600 border border-emerald-200 px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-100">
                            <i data-lucide="download" class="w-4 h-4"></i> 导出 Excel
                        </button>
                        <button id="btnAddOrder" onclick="openOrderModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md">发布订单</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs"><tr id="orderHead"></tr></thead>
                        <tbody id="orderTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="section-products" class="section hidden space-y-6">
                <div class="flex justify-between"><h2 class="text-2xl font-bold text-slate-800">产品库</h2><button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">新增产品</button></div>
                <div id="productList" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <div id="section-users" class="section hidden space-y-6">
                <div class="flex justify-between"><h2 class="text-2xl font-bold text-slate-800">供应商账号管理</h2><button onclick="addNewSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">新增供应商账号</button></div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold text-xs"><tr><th class="p-4">供应商名</th><th class="p-4">用户名</th><th class="p-4">状态</th><th class="p-4 text-right">操作</th></tr></thead><tbody id="userTableBody" class="divide-y divide-slate-100"></tbody></table>
                </div>
            </div>
        </main>
    </div>

    <script>
        let token = localStorage.getItem('srm_token');
        let currentUser = JSON.parse(localStorage.getItem('srm_user') || '{}');
        let productsCache = [];

        // 核心：带 Token 的请求封装
        async function api(url, options = {}) {
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            const res = await fetch(url, options);
            if (res.status === 401 || res.status === 403) {
                const err = await res.json();
                Swal.fire('认证失败', err.message, 'warning');
                logout();
                throw 'Auth Error';
            }
            return res.json();
        }

        window.onload = () => { if(token) enterSystem(); lucide.createIcons(); };

        async function handleLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                if(data.success) {
                    token = data.token; currentUser = data.user;
                    localStorage.setItem('srm_token', token);
                    localStorage.setItem('srm_user', JSON.stringify(currentUser));
                    enterSystem();
                } else { Swal.fire('登录失败', data.message, 'error'); }
            } catch(e) { Swal.fire('错误', '无法连接服务器', 'error'); }
        }

        function enterSystem() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = `${currentUser.nickname} (${currentUser.role === 'admin'?'管理端':'供应商端'})`;
            
            if(currentUser.role !== 'admin') {
                ['navProducts', 'navUsers', 'btnAddOrder'].forEach(id => document.getElementById(id).style.display = 'none');
            }
            showSection('dashboard');
        }

        function logout() { localStorage.clear(); location.reload(); }

        function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('sidebar-item-active'));
            if(name === 'dashboard') loadDashboard();
            if(name === 'orders') loadOrders();
            if(name === 'products') loadProducts();
            if(name === 'users') loadUsers();
            lucide.createIcons();
        }

        // --- 用户自改密码 ---
        async function changeOwnPassword() {
            const { value: pass } = await Swal.fire({
                title: '修改我的登录密码',
                input: 'password',
                inputPlaceholder: '请输入新密码',
                showCancelButton: true
            });
            if(pass) {
                await api('/api/user/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({newPassword: pass})
                });
                Swal.fire('成功', '密码已修改，下次登录生效', 'success');
            }
        }

        // --- 供应商管理 (管理员) ---
        async function loadUsers() {
            const users = await api('/api/admin/users');
            const body = document.getElementById('userTableBody');
            body.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-bold">${u.nickname}</td>
                    <td class="p-4">${u.username}</td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-xs ${u.status?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-700'}">${u.status?'活动':'已禁用'}</span></td>
                    <td class="p-4 text-right space-x-2">
                        <button onclick="resetUserPass(${u.id})" class="text-indigo-600 hover:underline">重置密码</button>
                        <button onclick="toggleUser(${u.id}, ${u.status})" class="text-slate-500 hover:underline">${u.status?'禁用':'启用'}</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewSupplier() {
            const { value: v } = await Swal.fire({
                title: '开通新供应商账号',
                html: `<input id="sw-un" class="swal2-input" placeholder="登录用户名"><input id="sw-pw" class="swal2-input" placeholder="登录密码"><input id="sw-nk" class="swal2-input" placeholder="供应商全称">`,
                preConfirm: () => ({ username: document.getElementById('sw-un').value, password: document.getElementById('sw-pw').value, nickname: document.getElementById('sw-nk').value })
            });
            if(v) {
                try {
                    await api('/api/admin/users', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(v) });
                    loadUsers();
                } catch(e) {}
            }
        }

        async function resetUserPass(id) {
            const { value: pass } = await Swal.fire({ title: '重置该供应商密码', input: 'password', showCancelButton: true });
            if(pass) {
                await api('/api/admin/users/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, password: pass}) });
                Swal.fire('成功', '密码重置成功', 'success');
            }
        }

        async function toggleUser(id, current) {
            await api('/api/admin/users/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id, status: current?0:1}) });
            loadUsers();
        }

        // --- Excel 导出 ---
        async function exportOrdersExcel() {
            const data = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const worksheet = XLSX.utils.json_to_sheet(data.map(o => ({
                "订单号": o.order_no,
                "供应商": o.supplier_name,
                "产品 SKU": o.sku,
                "名称": o.name,
                "数量": o.quantity,
                "总金额": o.total_price,
                "状态": o.status,
                "创建时间": o.created_at
            })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "订单台账");
            XLSX.writeFile(workbook, `SRM_Orders_${new Date().toLocaleDateString()}.xlsx`);
        }

        // --- 基础业务逻辑 (仪表盘、订单、SKU) 保持并注入 API 函数 ---
        async function loadDashboard() {
            try {
                const data = await api('/api/stats/admin');
                document.getElementById('stats-grid').innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase">累计采购</p><h3 class="text-2xl font-black mt-2">￥${(data.stats.amount||0).toLocaleString()}</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase">待处理单据</p><h3 class="text-2xl font-black mt-2 text-amber-500">${data.stats.pending}</h3></div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><p class="text-slate-400 text-xs font-bold uppercase">活跃账号</p><h3 class="text-2xl font-black mt-2">${data.chart.length}</h3></div>
                `;
                // 图表逻辑同上...
            } catch(e) {}
        }

        async function loadOrders() {
            const data = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const body = document.getElementById('orderTableBody');
            body.innerHTML = data.map(o => `
                <tr class="hover:bg-slate-50">
                    <td class="p-4 font-bold text-indigo-600">${o.order_no}<div class="text-[10px] text-slate-400">${o.sku}</div></td>
                    <td class="p-4">${o.name}<br><small class="text-slate-400">${o.spec}</small></td>
                    <td class="p-4 font-medium text-slate-600">${o.supplier_name}</td>
                    <td class="p-4">￥${o.total_price}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded-full text-[10px] font-bold ${o.status==='待确认'?'bg-amber-100 text-amber-600':'bg-emerald-100 text-emerald-600'}">${o.status}</span></td>
                    <td class="p-4 text-right">${currentUser.role==='admin'&&o.status==='已发货'?`<button onclick="confirmReceive(${o.id})" class="text-xs bg-indigo-600 text-white px-2 py-1 rounded">确认收货</button>`:'-'}</td>
                </tr>
            `).join('');
        }

        async function confirmReceive(id) {
            await api('/api/orders/receive', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) });
            Swal.fire('已收货', '订单已标记为完成', 'success');
            loadOrders();
        }

        // ... 产品库 loadProducts, openOrderModal 等逻辑请保留并确保内部 fetch 换成 api() 函数 ...
    </script>
</body>
</html>