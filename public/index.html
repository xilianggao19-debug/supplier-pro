<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRM 企业级供应商系统 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        .sidebar-item-active { background: #4f46e5; color: white; }
        .section { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- 登录界面 -->
    <div id="loginPage" class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-indigo-600">
            <h1 class="text-2xl font-bold text-center mb-2 text-slate-800 text-nowrap">SRM 智慧供应链</h1>
            <p class="text-slate-400 text-center mb-8 text-sm">Secure Authentication Pro</p>
            <div class="space-y-4">
                <input id="loginUser" type="text" placeholder="用户名" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <input id="loginPass" type="password" placeholder="密码" class="w-full border p-3 rounded-xl outline-none focus:ring-2 ring-indigo-100">
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200">进入系统</button>
            </div>
            <p class="mt-6 text-center text-xs text-slate-300">默认账号: admin / 123</p>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainPage" class="hidden flex h-screen overflow-hidden">
        <!-- 侧边栏 -->
        <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shrink-0">
            <div class="p-6 text-white font-bold text-xl flex items-center gap-2">
                <i data-lucide="shield-check" class="text-indigo-400"></i> SRM Pro
            </div>
            <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
                <button onclick="showSection('dashboard')" id="btn-nav-dashboard" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> 控制台
                </button>
                <button onclick="showSection('orders')" id="btn-nav-orders" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i> 订单中心
                </button>
                <button id="navProducts" onclick="showSection('products')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="package" class="w-5 h-5"></i> SKU 档案库
                </button>
                <button id="navUsers" onclick="showSection('users')" class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition">
                    <i data-lucide="users" class="w-5 h-5"></i> 供应商管理
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800 bg-slate-900/50">
                <div class="text-xs text-slate-500 mb-3 truncate" id="userNameDisplay"></div>
                <div class="space-y-2">
                    <button onclick="changeOwnPassword()" class="w-full text-left text-xs text-indigo-400 hover:text-indigo-300 flex items-center gap-2">
                        <i data-lucide="key" class="w-3 h-3"></i> 修改我的密码
                    </button>
                    <button onclick="logout()" class="w-full text-left text-xs text-red-400 hover:text-red-300 flex items-center gap-2">
                        <i data-lucide="log-out" class="w-3 h-3"></i> 退出系统
                    </button>
                </div>
            </div>
        </aside>

        <!-- 内容区 -->
        <main class="flex-1 overflow-y-auto p-8 bg-slate-50">
            
            <!-- 控制台 Section -->
            <div id="section-dashboard" class="section space-y-6">
                <h2 class="text-2xl font-bold text-slate-800">控制台概览</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="stats-grid">
                    <!-- 统计卡片由 JS 加载 -->
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 uppercase">供应商采购分布</h3>
                    <canvas id="supplierChart" height="100"></canvas>
                </div>
            </div>

            <!-- 订单中心 Section -->
            <div id="section-orders" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">订单中心</h2>
                    <div class="flex gap-3">
                        <button onclick="exportOrdersExcel()" class="bg-emerald-50 text-emerald-600 border border-emerald-200 px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-100 transition">
                            <i data-lucide="download" class="w-4 h-4"></i> 导出 Excel
                        </button>
                        <button id="btnAddOrder" onclick="openOrderModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transition">发布新订单</button>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase">
                            <tr>
                                <th class="p-4">订单信息</th>
                                <th class="p-4">产品详情</th>
                                <th class="p-4">供应商</th>
                                <th class="p-4">总金额</th>
                                <th class="p-4">状态</th>
                                <th class="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody" class="divide-y divide-slate-100">
                            <!-- 数据加载 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SKU 库 Section -->
            <div id="section-products" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">SKU 产品库</h2>
                    <button onclick="openProductModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">新增 SKU</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase">
                            <tr>
                                <th class="p-4">SKU 编号</th>
                                <th class="p-4">产品名称</th>
                                <th class="p-4">规格参数</th>
                                <th class="p-4">基准单价</th>
                                <th class="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- 用户管理 Section -->
            <div id="section-users" class="section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-slate-800">账号管理</h2>
                    <button onclick="addNewSupplier()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">新增供应商账号</button>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 font-bold text-xs uppercase">
                            <tr>
                                <th class="p-4">供应商名称</th>
                                <th class="p-4">登录用户名</th>
                                <th class="p-4">账号状态</th>
                                <th class="p-4 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <!-- 订单弹窗模板 (隐藏) -->
    <template id="orderModalTpl">
        <div class="text-left space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">1. 选择产品 (SKU)</label>
                <select id="md-sku" class="w-full border p-3 rounded-xl mt-1 bg-slate-50" onchange="autoFillProduct(this.value)">
                    <option value="">-- 点击选择 SKU --</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">产品名称</label>
                    <input id="md-name" class="w-full border p-3 rounded-xl mt-1 bg-slate-100" readonly>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">规格</label>
                    <input id="md-spec" class="w-full border p-3 rounded-xl mt-1 bg-slate-100" readonly>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">采购数量</label>
                    <input id="md-qty" type="number" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 ring-indigo-100 outline-none" value="1">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">协议单价</label>
                    <input id="md-price" type="number" class="w-full border p-3 rounded-xl mt-1 focus:ring-2 ring-indigo-100 outline-none">
                </div>
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">2. 分配供应商</label>
                <select id="md-supplier" class="w-full border p-3 rounded-xl mt-1 bg-slate-50">
                    <option value="">-- 选择接收订单的供应商 --</option>
                </select>
            </div>
        </div>
    </template>

    <script>
        let token = localStorage.getItem('srm_token');
        let currentUser = JSON.parse(localStorage.getItem('srm_user') || '{}');
        let productsCache = [];
        let chartInstance = null;

        // 封装 API 请求
        async function api(url, options = {}) {
            options.headers = { 
                ...options.headers, 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
            try {
                const res = await fetch(url, options);
                if (res.status === 401 || res.status === 403) {
                    localStorage.clear();
                    location.reload();
                    throw 'Session Expired';
                }
                const data = await res.json();
                if (!res.ok) throw data.message || '请求失败';
                return data;
            } catch (err) {
                Swal.fire('提示', err.toString(), 'warning');
                throw err;
            }
        }

        // 页面入口
        window.onload = () => {
            if (token && currentUser.id) {
                enterSystem();
            }
            lucide.createIcons();
        };

        // 登录逻辑
        async function handleLogin() {
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            if(!username || !password) return Swal.fire('请完整填写', '', 'info');

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });
                const data = await res.json();
                if(data.success) {
                    token = data.token; 
                    currentUser = data.user;
                    localStorage.setItem('srm_token', token);
                    localStorage.setItem('srm_user', JSON.stringify(currentUser));
                    enterSystem();
                } else {
                    Swal.fire('登录失败', data.message, 'error');
                }
            } catch(e) {
                Swal.fire('连接失败', '请检查服务器是否运行', 'error');
            }
        }

        function enterSystem() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainPage').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = `你好，${currentUser.nickname}`;
            
            // 权限控制
            if(currentUser.role !== 'admin') {
                ['navProducts', 'navUsers', 'btnAddOrder'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.style.display = 'none';
                });
            }
            showSection('dashboard');
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // 切换板块
        async function showSection(name) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`section-${name}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('sidebar-item-active'));
            const activeBtn = document.getElementById(`btn-nav-${name}`) || document.getElementById(`nav${name.charAt(0).toUpperCase() + name.slice(1)}`);
            if(activeBtn) activeBtn.classList.add('sidebar-item-active');

            if(name === 'dashboard') loadDashboard();
            if(name === 'orders') loadOrders();
            if(name === 'products') loadProducts();
            if(name === 'users') loadUsers();
            
            lucide.createIcons();
        }

        // --- 控制台逻辑 ---
        async function loadDashboard() {
            const data = await api('/api/stats/admin');
            document.getElementById('stats-grid').innerHTML = `
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-[10px] font-bold uppercase">累计采购总额</p>
                    <h3 class="text-2xl font-black mt-2">￥${(data.stats.amount || 0).toLocaleString()}</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-[10px] font-bold uppercase">待处理订单</p>
                    <h3 class="text-2xl font-black mt-2 text-amber-500">${data.stats.pending}</h3>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <p class="text-slate-400 text-[10px] font-bold uppercase">合作供应商</p>
                    <h3 class="text-2xl font-black mt-2">${data.chart.length}</h3>
                </div>
            `;
            renderChart(data.chart);
        }

        function renderChart(chartData) {
            const ctx = document.getElementById('supplierChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(i => i.name),
                    datasets: [{ label: '采购额 (元)', data: chartData.map(i => i.value), backgroundColor: '#6366f1', borderRadius: 8 }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        // --- 产品库逻辑 ---
        async function loadProducts() {
            productsCache = await api('/api/products');
            const body = document.getElementById('productTableBody');
            body.innerHTML = productsCache.map(p => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-mono font-bold text-slate-400 text-xs">${p.sku}</td>
                    <td class="p-4 font-bold text-slate-700">${p.name}</td>
                    <td class="p-4 text-slate-500">${p.spec}</td>
                    <td class="p-4 font-bold text-indigo-600">￥${p.unit_price}</td>
                    <td class="p-4 text-right">
                        <button onclick="deleteProduct(${p.id})" class="text-red-400 hover:text-red-600 transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function openProductModal() {
            const { value: f } = await Swal.fire({
                title: '新增产品档案',
                html: `
                    <input id="sw-sku" class="swal2-input" placeholder="SKU 编号 (如: SKU001)">
                    <input id="sw-name" class="swal2-input" placeholder="产品名称">
                    <input id="sw-spec" class="swal2-input" placeholder="规格型号">
                    <input id="sw-price" type="number" class="swal2-input" placeholder="基准单价">
                `,
                preConfirm: () => ({
                    sku: document.getElementById('sw-sku').value,
                    name: document.getElementById('sw-name').value,
                    spec: document.getElementById('sw-spec').value,
                    unit_price: document.getElementById('sw-price').value
                })
            });
            if(f && f.sku) {
                await api('/api/products', { method: 'POST', body: JSON.stringify(f) });
                loadProducts();
                Swal.fire('已录入', '', 'success');
            }
        }

        async function deleteProduct(id) {
            if(!confirm('确定删除该产品档案吗？')) return;
            await api(`/api/products/${id}`, { method: 'DELETE' });
            loadProducts();
        }

        // --- 订单逻辑 ---
        async function loadOrders() {
            const orders = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const body = document.getElementById('orderTableBody');
            body.innerHTML = orders.map(o => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4">
                        <div class="font-bold text-indigo-600">#${o.order_no}</div>
                        <div class="text-[10px] text-slate-400 uppercase tracking-tighter">${o.created_at.slice(0,10)}</div>
                    </td>
                    <td class="p-4">
                        <div class="font-bold text-slate-700">${o.name}</div>
                        <div class="text-xs text-slate-400">${o.sku} | ${o.spec} x ${o.quantity}</div>
                    </td>
                    <td class="p-4 font-medium text-slate-600">${o.supplier_name}</td>
                    <td class="p-4 font-bold text-slate-800">￥${o.total_price.toLocaleString()}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold ${o.status==='已完成'?'bg-emerald-100 text-emerald-600':'bg-amber-100 text-amber-600'}">
                            ${o.status}
                        </span>
                    </td>
                    <td class="p-4 text-right">
                        ${getActionBtn(o)}
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function getActionBtn(o) {
            if(currentUser.role === 'admin' && o.status === '已发货') {
                return `<button onclick="confirmReceive(${o.id})" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs shadow-sm">确认收货</button>`;
            }
            if(currentUser.role === 'supplier' && o.status === '待确认') {
                return `<button onclick="confirmShipping(${o.id})" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs shadow-sm">去发货</button>`;
            }
            return '<span class="text-slate-300 text-xs">暂无操作</span>';
        }

        async function openOrderModal() {
            if(productsCache.length === 0) productsCache = await api('/api/products');
            const suppliers = await api('/api/suppliers-list');

            const { value: f } = await Swal.fire({
                title: '发布采购订单',
                html: document.getElementById('orderModalTpl').innerHTML,
                didOpen: () => {
                    const skuSel = document.getElementById('md-sku');
                    productsCache.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.sku; opt.text = `${p.sku} - ${p.name}`;
                        skuSel.appendChild(opt);
                    });
                    const supSel = document.getElementById('md-supplier');
                    suppliers.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id; opt.text = s.nickname;
                        supSel.appendChild(opt);
                    });
                },
                preConfirm: () => ({
                    order_no: 'PO' + Date.now().toString().slice(-6),
                    sku: document.getElementById('md-sku').value,
                    name: document.getElementById('md-name').value,
                    spec: document.getElementById('md-spec').value,
                    quantity: document.getElementById('md-qty').value,
                    unit_price: document.getElementById('md-price').value,
                    supplier_id: document.getElementById('md-supplier').value
                })
            });

            if(f && f.sku && f.supplier_id) {
                await api('/api/orders', { method: 'POST', body: JSON.stringify(f) });
                Swal.fire('发布成功', '供应商将收到提醒', 'success');
                loadOrders();
            }
        }

        function autoFillProduct(sku) {
            const p = productsCache.find(x => x.sku === sku);
            if(p) {
                document.getElementById('md-name').value = p.name;
                document.getElementById('md-spec').value = p.spec;
                document.getElementById('md-price').value = p.unit_price;
            }
        }

        async function confirmReceive(id) {
            await api('/api/orders/receive', { method: 'POST', body: JSON.stringify({id}) });
            Swal.fire('已完成', '货物已入库', 'success');
            loadOrders();
        }

        // --- 账号管理逻辑 ---
        async function loadUsers() {
            const users = await api('/api/admin/users');
            const body = document.getElementById('userTableBody');
            body.innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4 font-bold text-slate-700">${u.nickname}</td>
                    <td class="p-4 text-slate-500">${u.username}</td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${u.status?'bg-emerald-50 text-emerald-600':'bg-red-50 text-red-600'}">
                            ${u.status?'正常活跃':'已锁定'}
                        </span>
                    </td>
                    <td class="p-4 text-right space-x-3">
                        <button onclick="resetUserPass(${u.id})" class="text-indigo-600 text-xs font-bold hover:underline">重置密码</button>
                        <button onclick="toggleUser(${u.id}, ${u.status})" class="text-slate-400 text-xs hover:underline">${u.status?'禁用':'启用'}</button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewSupplier() {
            const { value: v } = await Swal.fire({
                title: '开通供应商账号',
                html: `
                    <input id="sw-un" class="swal2-input" placeholder="登录用户名">
                    <input id="sw-pw" class="swal2-input" placeholder="初始密码">
                    <input id="sw-nk" class="swal2-input" placeholder="供应商全称 (如: 某某实业)">
                `,
                preConfirm: () => ({
                    username: document.getElementById('sw-un').value,
                    password: document.getElementById('sw-pw').value,
                    nickname: document.getElementById('sw-nk').value
                })
            });
            if(v && v.username) {
                await api('/api/admin/users', { method: 'POST', body: JSON.stringify(v) });
                loadUsers();
                Swal.fire('创建成功', '', 'success');
            }
        }

        async function resetUserPass(id) {
            const { value: p } = await Swal.fire({ title: '重置该账号密码', input: 'password', showCancelButton: true });
            if(p) {
                await api('/api/admin/users/update', { method: 'POST', body: JSON.stringify({id, password: p}) });
                Swal.fire('密码已重置', '', 'success');
            }
        }

        async function toggleUser(id, cur) {
            await api('/api/admin/users/update', { method: 'POST', body: JSON.stringify({id, status: cur?0:1}) });
            loadUsers();
        }

        async function changeOwnPassword() {
            const { value: p } = await Swal.fire({ title: '修改我的登录密码', input: 'password', showCancelButton: true });
            if(p) {
                await api('/api/user/change-password', { method: 'POST', body: JSON.stringify({newPassword: p}) });
                Swal.fire('成功', '新密码将在下次登录生效', 'success');
            }
        }

        // 导出 Excel
        async function exportOrdersExcel() {
            const data = await api(`/api/orders?role=${currentUser.role}&userId=${currentUser.id}`);
            const ws = XLSX.utils.json_to_sheet(data.map(o => ({
                "单号": o.order_no, "日期": o.created_at, "供应商": o.supplier_name,
                "SKU": o.sku, "名称": o.name, "规格": o.spec, "数量": o.quantity,
                "单价": o.unit_price, "总价": o.total_price, "状态": o.status
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "订单报表");
            XLSX.writeFile(wb, `Order_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>